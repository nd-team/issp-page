<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/draft.js - editor-plugins</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="editor-plugins"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: editor-plugins 1.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/BackColor.html">BackColor</a></li>
            
                <li><a href="../classes/Bold.html">Bold</a></li>
            
                <li><a href="../classes/Button.html">Button</a></li>
            
                <li><a href="../classes/CheckBoxSourceArea.html">CheckBoxSourceArea</a></li>
            
                <li><a href="../classes/Code.html">Code</a></li>
            
                <li><a href="../classes/Draft.html">Draft</a></li>
            
                <li><a href="../classes/DragUpload.html">DragUpload</a></li>
            
                <li><a href="../classes/ElementPath.html">ElementPath</a></li>
            
                <li><a href="../classes/Flash.html">Flash</a></li>
            
                <li><a href="../classes/FontColor.html">FontColor</a></li>
            
                <li><a href="../classes/FontFamily.html">FontFamily</a></li>
            
                <li><a href="../classes/FontSize.html">FontSize</a></li>
            
                <li><a href="../classes/Heading.html">Heading</a></li>
            
                <li><a href="../classes/Image.html">Image</a></li>
            
                <li><a href="../classes/Indent.html">Indent</a></li>
            
                <li><a href="../classes/Italic.html">Italic</a></li>
            
                <li><a href="../classes/JustifyCenter.html">JustifyCenter</a></li>
            
                <li><a href="../classes/JustifyLeft.html">JustifyLeft</a></li>
            
                <li><a href="../classes/JustifyRight.html">JustifyRight</a></li>
            
                <li><a href="../classes/Link.html">Link</a></li>
            
                <li><a href="../classes/Maximize.html">Maximize</a></li>
            
                <li><a href="../classes/MultipleUpload.html">MultipleUpload</a></li>
            
                <li><a href="../classes/OrderedList.html">OrderedList</a></li>
            
                <li><a href="../classes/Outdent.html">Outdent</a></li>
            
                <li><a href="../classes/PageBreak.html">PageBreak</a></li>
            
                <li><a href="../classes/Preview.html">Preview</a></li>
            
                <li><a href="../classes/RemoveFormat.html">RemoveFormat</a></li>
            
                <li><a href="../classes/Resize.html">Resize</a></li>
            
                <li><a href="../classes/Separator.html">Separator</a></li>
            
                <li><a href="../classes/Smiley.html">Smiley</a></li>
            
                <li><a href="../classes/SourceArea.html">SourceArea</a></li>
            
                <li><a href="../classes/StrikeThrough.html">StrikeThrough</a></li>
            
                <li><a href="../classes/Table.html">Table</a></li>
            
                <li><a href="../classes/Underline.html">Underline</a></li>
            
                <li><a href="../classes/Undo.html">Undo</a></li>
            
                <li><a href="../classes/UnorderedList.html">UnorderedList</a></li>
            
                <li><a href="../classes/Video.html">Video</a></li>
            
                <li><a href="../classes/XiaMiMusic.html">XiaMiMusic</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/back-color.html">back-color</a></li>
            
                <li><a href="../modules/bold.html">bold</a></li>
            
                <li><a href="../modules/button.html">button</a></li>
            
                <li><a href="../modules/checkbox-source-area.html">checkbox-source-area</a></li>
            
                <li><a href="../modules/code.html">code</a></li>
            
                <li><a href="../modules/draft.html">draft</a></li>
            
                <li><a href="../modules/drag-upload.html">drag-upload</a></li>
            
                <li><a href="../modules/eindent.html">eindent</a></li>
            
                <li><a href="../modules/element-path.html">element-path</a></li>
            
                <li><a href="../modules/flash.html">flash</a></li>
            
                <li><a href="../modules/font-color.html">font-color</a></li>
            
                <li><a href="../modules/font-family.html">font-family</a></li>
            
                <li><a href="../modules/font-size.html">font-size</a></li>
            
                <li><a href="../modules/heading.html">heading</a></li>
            
                <li><a href="../modules/image.html">image</a></li>
            
                <li><a href="../modules/italic.html">italic</a></li>
            
                <li><a href="../modules/justify-center.html">justify-center</a></li>
            
                <li><a href="../modules/justify-left.html">justify-left</a></li>
            
                <li><a href="../modules/justify-right.html">justify-right</a></li>
            
                <li><a href="../modules/link.html">link</a></li>
            
                <li><a href="../modules/maximize.html">maximize</a></li>
            
                <li><a href="../modules/multiple-upload.html">multiple-upload</a></li>
            
                <li><a href="../modules/ordered-list.html">ordered-list</a></li>
            
                <li><a href="../modules/outdent.html">outdent</a></li>
            
                <li><a href="../modules/page-break.html">page-break</a></li>
            
                <li><a href="../modules/preview.html">preview</a></li>
            
                <li><a href="../modules/remove-format.html">remove-format</a></li>
            
                <li><a href="../modules/resize.html">resize</a></li>
            
                <li><a href="../modules/separator.html">separator</a></li>
            
                <li><a href="../modules/smiley.html">smiley</a></li>
            
                <li><a href="../modules/source-area.html">source-area</a></li>
            
                <li><a href="../modules/strike-through.html">strike-through</a></li>
            
                <li><a href="../modules/table.html">table</a></li>
            
                <li><a href="../modules/underline.html">underline</a></li>
            
                <li><a href="../modules/undo.html">undo</a></li>
            
                <li><a href="../modules/unordered-list.html">unordered-list</a></li>
            
                <li><a href="../modules/video.html">video</a></li>
            
                <li><a href="../modules/xiami-music.html">xiami-music</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/draft.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @ignore
 * draft for kissy editor
 * @author yiminghe@gmail.com
 */

var Editor = require(&#x27;editor&#x27;);
var Json = require(&#x27;json&#x27;);
var Event = require(&#x27;event/dom&#x27;);
/*global localStorage:true*/
var localStorage = require(&#x27;./local-storage&#x27;);
var Overlay = require(&#x27;overlay&#x27;);
var MenuButton = require(&#x27;./menubutton&#x27;);

var util = require(&#x27;util&#x27;);
var $ = require(&#x27;node&#x27;),
    LIMIT = 5,
    INTERVAL = 5,
    DRAFT_SAVE = &#x27;ks-editor-draft-save20110503&#x27;;

function padding(n, l, p) {
    n += &#x27;&#x27;;
    while (n.length &lt; l) {
        n = p + n;
    }
    return n;
}

function date(d) {
    if (typeof d === &#x27;number&#x27;) {
        d = new Date(d);
    }
    if (d instanceof Date) {
        return [
            d.getFullYear(),
            &#x27;-&#x27;,
            padding(d.getMonth() + 1, 2, &#x27;0&#x27;),
            &#x27;-&#x27;,
            padding(d.getDate(), 2, &#x27;0&#x27;),
            &#x27; &#x27;,
            //&#x27;&amp;nbsp;&#x27;,
            padding(d.getHours(), 2, &#x27;0&#x27;),
            &#x27;:&#x27;,
            padding(d.getMinutes(), 2, &#x27;0&#x27;),
            &#x27;:&#x27;,
            padding(d.getSeconds(), 2, &#x27;0&#x27;)
            //&#x27;&amp;nbsp;&#x27;,
            //&#x27;&amp;nbsp;&#x27;
        ].join(&#x27;&#x27;);
    }
    else {
        return d;
    }
}

function Draft(editor, config) {
    this.editor = editor;
    this.config = config;
    this._init();
}

var addRes = Editor.Utils.addRes,
    destroyRes = Editor.Utils.destroyRes;

util.augment(Draft, {
    _getSaveKey: function () {
        var self = this,
            cfg = self.config;
        return cfg.saveKey || DRAFT_SAVE;
    },


    // parse 历史记录延后，点击 select 时才开始 parse
    _getDrafts: function () {
        var self = this;
        if (!self.drafts) {
            var str = localStorage.getItem(self._getSaveKey()),
                drafts = [];
            if (str) {
                // 原生 localStorage 必须串行化
                drafts = (localStorage === window.localStorage) ?
                    Json.parse(util.urlDecode(str)) : str;
            }
            self.drafts = drafts;
        }
        return self.drafts;
    },

    _init: function () {
        var self = this,
            editor = self.editor,
            prefixCls = editor.get(&#x27;prefixCls&#x27;),
            statusbar = editor.get(&#x27;statusBarEl&#x27;),
            cfg = this.config;
        cfg.limit = cfg.limit || LIMIT;
        cfg.interval = cfg.interval || INTERVAL;
        var holder = $(
                &#x27;&lt;div class=&quot;&#x27; + prefixCls + &#x27;editor-draft&quot;&gt;&#x27; +
                &#x27;&lt;span class=&quot;&#x27; + prefixCls + &#x27;editor-draft-title&quot;&gt;&#x27; +
                &#x27;内容正文每&#x27; +
                cfg.interval + &#x27;分钟自动保存一次。&#x27; +
                &#x27;&lt;/span&gt;&#x27; +
                &#x27;&lt;/div&gt;&#x27;).appendTo(statusbar);
        self.timeTip = $(&#x27;&lt;span class=&quot;&#x27; + prefixCls + &#x27;editor-draft-time&quot;/&gt;&#x27;)
            .appendTo(holder);

        var save = $(
                util.substitute(&#x27;&lt;a href=&quot;#&quot; &#x27; +
                    &#x27;onclick=&quot;return false;&quot; &#x27; +
                    &#x27;class=&quot;{prefixCls}editor-button &#x27; +
                    &#x27;{prefixCls}editor-draft-save-btn ks-inline-block&quot; &#x27; +
                    &#x27;style=&quot;&#x27; +
                    &#x27;vertical-align:middle;&#x27; +
                    &#x27;padding:1px 9px;&#x27; +
                    &#x27;&quot;&gt;&#x27; +
                    &#x27;&lt;span class=&quot;{prefixCls}editor-draft-save&quot;&gt;&#x27; +
                    &#x27;&lt;/span&gt;&#x27; +
                    &#x27;&lt;span&gt;立即保存&lt;/span&gt;&#x27; +
                    &#x27;&lt;/a&gt;&#x27;, { prefixCls: prefixCls
                })).unselectable(undefined).appendTo(holder),
            versions = new MenuButton({
                render: holder,
                collapseOnClick: true,
                width: &#x27;100px&#x27;,
                prefixCls: prefixCls + &#x27;editor-&#x27;,
                menu: {
                    width: &#x27;225px&#x27;,
                    align: {
                        points: [&#x27;tr&#x27;, &#x27;br&#x27;]
                    }
                },
                matchElWidth: false,
                content: &#x27;恢复编辑历史&#x27;
            }).render();
        self.versions = versions;
        // 点击才开始 parse
        versions.on(&#x27;beforeCollapsedChange&#x27;, function beforeCollapsedChange(e) {
            if (!e.newValue) {
                versions.detach(&#x27;beforeCollapsedChange&#x27;, beforeCollapsedChange);
                self.sync();
            }
        });
        save.on(&#x27;click&#x27;, function (ev) {
            self.save(false);
            //如果不阻止，部分页面在ie6下会莫名奇妙把其他input的值丢掉！
            ev.halt();
        });

        addRes.call(self, save);

        /*
         监控form提交，每次提交前保存一次，防止出错
         */
        if (editor.get(&#x27;textarea&#x27;)[0].form) {
            (function () {
                var textarea = editor.get(&#x27;textarea&#x27;),
                    form = textarea[0].form;

                function saveF() {
                    self.save(true);
                }

                Event.on(form, &#x27;submit&#x27;, saveF);
                addRes.call(self, function () {
                    Event.remove(form, &#x27;submit&#x27;, saveF);
                });

            })();
        }

        var timer = setInterval(function () {
            self.save(true);
        }, self.config.interval * 60 * 1000);

        addRes.call(self, function () {
            clearInterval(timer);
        });

        versions.on(&#x27;click&#x27;, self.recover, self);
        addRes.call(self, versions);
        self.holder = holder;
        if (cfg.helpHtml) {
            var help = $(&#x27;&lt;a &#x27; +
                &#x27;tabindex=&quot;0&quot; &#x27; +
                &#x27;hidefocus=&quot;hidefocus&quot; &#x27; +
                &#x27;class=&quot;&#x27; + prefixCls + &#x27;editor-draft-help&quot; &#x27; +
                &#x27;title=&quot;点击查看帮助&quot; &#x27; +
                &#x27;href=&quot;javascript:void(\&#x27;点击查看帮助 \&#x27;)&quot;&gt;点击查看帮助&lt;/a&gt;&#x27;)
                .unselectable(undefined)
                .appendTo(holder);

            help.on(&#x27;click&#x27;, function () {
                help[0].focus();
                if (self.helpPopup &amp;&amp; self.helpPopup.get(&#x27;visible&#x27;)) {
                    self.helpPopup.hide();
                } else {
                    self._prepareHelp();
                }
            });
            help.on(&#x27;blur&#x27;, function () {
                if (self.helpPopup) {
                    self.helpPopup.hide();
                }
            });
            self.helpBtn = help;
            addRes.call(self, help);
            Editor.Utils.lazyRun(self, &#x27;_prepareHelp&#x27;, &#x27;_realHelp&#x27;);
        }
        addRes.call(self, holder);
    },
    _prepareHelp: function () {
        var self = this,
            editor = self.editor,
            prefixCls = editor.get(&#x27;prefixCls&#x27;),
            cfg = self.config,
            draftCfg = cfg,
            help = $(draftCfg.helpHtml || &#x27;&#x27;);
        var arrowCss = &#x27;height:0;&#x27; +
            &#x27;position:absolute;&#x27; +
            &#x27;font-size:0;&#x27; +
            &#x27;width:0;&#x27; +
            &#x27;border:8px #000 solid;&#x27; +
            &#x27;border-color:#000 transparent transparent transparent;&#x27; +
            &#x27;border-style:solid dashed dashed dashed;&#x27;;
        var arrow = $(&#x27;&lt;div style=&quot;&#x27; +
            arrowCss +
            &#x27;border-top-color:#CED5E0;&#x27; +
            &#x27;&quot;&gt;&#x27; +
            &#x27;&lt;div style=&quot;&#x27; +
            arrowCss +
            &#x27;left:-8px;&#x27; +
            &#x27;top:-10px;&#x27; +
            &#x27;border-top-color:white;&#x27; +
            &#x27;&quot;&gt;&#x27; +
            &#x27;&lt;/div&gt;&#x27; +
            &#x27;&lt;/div&gt;&#x27;);
        help.append(arrow);
        help.css({
            border: &#x27;1px solid #ACB4BE&#x27;,
            &#x27;text-align&#x27;: &#x27;left&#x27;
        });
        self.helpPopup = new Overlay({
            prefixCls: prefixCls + &#x27;editor-&#x27;,
            width: help.outerWidth() + &#x27;px&#x27;,
            zIndex: Editor.baseZIndex(Editor.ZIndexManager.OVERLAY),
            mask: false
        }).render();
        self.helpPopup.get(&#x27;contentEl&#x27;).append(help);
        self.helpPopup.get(&#x27;el&#x27;).css({
            &#x27;border&#x27;: &#x27;none&#x27;,
            overflow: &#x27;visible&#x27;
        });
        self.helpPopup.arrow = arrow;
    },
    _realHelp: function () {
        var win = this.helpPopup,
            helpBtn = this.helpBtn,
            arrow = win.arrow;
        win.show();
        var off = helpBtn.offset();
        win.get(&#x27;el&#x27;).offset({
            left: (off.left - win.get(&#x27;el&#x27;).width()) + 17,
            top: (off.top - win.get(&#x27;el&#x27;).height()) - 7
        });
        arrow.offset({
            left: off.left - 2,
            top: off.top - 8
        });
    },
    disable: function () {
        this.holder.css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
    },
    enable: function () {
        this.holder.css(&#x27;visibility&#x27;, &#x27;&#x27;);
    },
    sync: function () {
        var self = this,
            i,
            timeTip = self.timeTip,
            versions = self.versions,
            drafts = self._getDrafts(),
            draft, tip;

        if (drafts.length &gt; self.config.limit) {
            drafts.splice(0, drafts.length - self.config.limit);
        }

        versions.removeItems(true);

        for (i = 0; i &lt; drafts.length; i++) {
            draft = drafts[i];
            tip = (draft.auto ? &#x27;自动&#x27; : &#x27;手动&#x27;) + &#x27;保存于 : &#x27; + date(draft.date);
            versions.addItem({
                content: tip,
                value: i
            });
        }

        if (!drafts.length) {
            versions.addItem({
                disabled: true,
                content: &#x27;尚无历史&#x27;,
                value: &#x27;&#x27;
            });
        }

        timeTip.html(tip);
        localStorage.setItem(self._getSaveKey(),
            (localStorage === window.localStorage) ?
                encodeURIComponent(Json.stringify(drafts))
                : drafts);
    },

    save: function (auto) {
        var self = this,
            drafts = self._getDrafts(),
            editor = self.editor,
        //不使用rawdata
        //undo 只需获得可视区域内代码
        //可视区域内代码！= 最终代码
        //代码模式也要支持草稿功能
        //统一获得最终代码
            data = editor.getFormatData();

        //如果当前内容为空，不保存版本
        if (!data) {
            return;
        }

        if (drafts[drafts.length - 1] &amp;&amp;
            data === drafts[drafts.length - 1].content) {
            drafts.length -= 1;
        }
        self.drafts = drafts.concat({
            content: data,
            date: new Date().getTime(),
            auto: auto
        });
        self.sync();
    },

    recover: function (ev) {
        var self = this,
            editor = self.editor,
            drafts = self._getDrafts(),
            v = ev.target.get(&#x27;value&#x27;);
        if (window.confirm(&#x27;确认恢复 &#x27; + date(drafts[v].date) + &#x27; 的编辑历史？&#x27;)) {
            editor.execCommand(&#x27;save&#x27;);
            editor.setData(drafts[v].content);
            editor.execCommand(&#x27;save&#x27;);
        }
        ev.halt();
    },

    destroy: function () {
        destroyRes.call(this);
    }
});

function init(editor, config) {
    var d = new Draft(editor, config);
    editor.on(&#x27;destroy&#x27;, function () {
        d.destroy();
    });
}

function DraftPlugin(config) {
    this.config = config || {};
}

util.augment(DraftPlugin, {
    pluginRenderUI: function (editor) {
        var config = this.config;
        if (localStorage.ready) {
            localStorage.ready(function () {
                init(editor, config);
            });
        } else {
            init(editor, config);
        }
    }
});

module.exports = DraftPlugin;
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
